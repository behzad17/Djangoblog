{% extends "base.html" %}
{% load i18n %}

{% block head_title %}{% if token_fail %}{% trans "Bad Token" %}{% else %}{% trans "Change Password" %}{% endif %}{% endblock head_title %}

{% block content %}
<!-- Hero Section -->
<section
  class="hero-section hero-section-login text-white mb-4"
  style="
    background: #76DFB1;
    padding: 2rem 0;
  "
>
  <div class="container">
    <div class="row justify-content-center text-center">
      <div class="col-lg-8">
        <h1 class="hero-title mb-3">
          {% if token_fail %}
            {% trans "لینک نامعتبر" %}
          {% else %}
            {% trans "تغییر رمز عبور" %}
          {% endif %}
        </h1>
        <p class="hero-subtitle mb-0">
          {% if token_fail %}
            {% blocktrans %}
            لینک تغییر رمز عبور نامعتبر است.
            {% endblocktrans %}
          {% else %}
            {% blocktrans %}
            رمز عبور جدید خود را وارد کنید.
            {% endblocktrans %}
          {% endif %}
        </p>
      </div>
    </div>
  </div>
</section>

<!-- Password Reset Container -->
<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-5 col-md-7 col-sm-9">
      <!-- Password Reset Card -->
      <div class="card login-card login-ltr mt-4 mb-5">
        <div class="card-body p-4">
          {% if token_fail %}
            <!-- Invalid Token Message -->
            <div class="text-center mb-4">
              <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading">{% trans "لینک نامعتبر" %}</h4>
                <p>
                  {% url 'account_reset_password' as passwd_reset_url %}
                  {% blocktrans %}
                  لینک تغییر رمز عبور نامعتبر است یا قبلاً استفاده شده است. لطفاً یک لینک جدید درخواست کنید.
                  {% endblocktrans %}
                </p>
                <hr>
                <p class="mb-0">
                  <a href="{% url 'account_reset_password' %}" class="btn btn-signup">
                    {% trans "درخواست لینک جدید" %}
                  </a>
                </p>
              </div>
            </div>
          {% else %}
            <!-- Header -->
            <div class="text-center mb-4" style="text-align: center;">
              <h2 class="card-title mb-2">{% trans "تغییر رمز عبور" %}</h2>
            </div>

            <!-- Password Reset Form -->
            <form method="POST" action="{{ action_url }}" class="password_reset_from_key">
              {% csrf_token %}
              
              {% if form.non_field_errors %}
                <div class="alert alert-danger text-center" role="alert">
                  {{ form.non_field_errors }}
                </div>
              {% endif %}

              {% for field in form %}
              <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label text-center d-block">
                  {% if field.name == 'password1' %}
                    {% trans "رمز عبور جدید" %}
                  {% elif field.name == 'password2' %}
                    {% trans "تأیید رمز عبور" %}
                  {% else %}
                    {{ field.label }}
                  {% endif %}
                  {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                </label>
                {{ field }}
                {% if field.errors %}
                  <div class="text-danger small mt-1 text-center">{{ field.errors }}</div>
                {% endif %}
                {% if field.help_text %}
                  <div class="form-text text-center">{{ field.help_text }}</div>
                {% endif %}
              </div>
              {% endfor %}

              <!-- Change Password Button -->
              <button class="btn btn-signup w-100 mb-3 text-center" type="submit" name="action" style="text-align: center;">
                {% trans "تغییر رمز عبور" %}
              </button>
            </form>

            <!-- Help Links -->
            <div class="text-center">
              <p class="mb-0 text-center">
                <a class="link" href="{% url 'account_login' %}">
                  {% trans "بازگشت به صفحه ورود" %}
                </a>
              </p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extras %}
<style>
    /* Ensure form inputs have Bootstrap styling and RTL support */
    .password_reset_from_key input[type="password"],
    .password_reset_from_key input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        direction: ltr;
        text-align: left;
    }
    
    .password_reset_from_key input[type="password"]:focus,
    .password_reset_from_key input[type="text"]:focus {
        border-color: #188181;
        box-shadow: 0 0 0 3px rgba(24, 129, 129, 0.1);
        outline: none;
    }
    
    /* Form labels RTL */
    .password_reset_from_key .form-label {
        direction: rtl;
        text-align: right;
    }
    
    /* Error messages RTL */
    .password_reset_from_key .text-danger {
        direction: rtl;
        text-align: right;
    }
    
    /* Help text RTL */
    .password_reset_from_key .form-text {
        direction: rtl;
        text-align: right;
    }
</style>
{% endblock extras %}
