{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}
<!-- Hero Section -->
<section
  class="hero-section text-white mb-4"
  style="
    background: #00A693;
    padding: 1.5rem 0;
  "
>
  <div class="container">
    <div class="row justify-content-center text-center">
      <div class="col-lg-8">
        <h1 class="hero-title mb-2" style="font-size: 1.75rem;">
          {{ ad.title }}
        </h1>
        <p class="hero-subtitle mb-0" style="font-size: 0.95rem;">
          دسته‌بندی: {{ ad.category.name }}
        </p>
      </div>
    </div>
  </div>
</section>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm border-0 {% if ad.is_currently_featured %}ad-featured{% endif %}">
        <div class="card-body text-center p-4 position-relative">
          {% if ad.is_currently_featured %}
          <span class="glass-card-badge glass-card-badge-featured" style="position: absolute; top: 15px; right: 15px;">
            <i class="fas fa-star ms-1"></i>ویژه
          </span>
          {% endif %}
          {% if ad.image %}
            {% if ad.target_url and ad.url_approved %}
            <a
              href="{{ ad.target_url }}"
              target="_blank"
              rel="noopener noreferrer"
              class="ad-image-link"
            >
              <img
                src="{{ ad.image.url }}"
                alt="{{ ad.title }}"
                class="img-fluid ad-detail-image"
                onerror="this.onerror=null; this.src='{% static 'images/default.jpg' %}';"
              />
            </a>
            {% else %}
            <img
              src="{{ ad.image.url }}"
              alt="{{ ad.title }}"
              class="img-fluid ad-detail-image"
              onerror="this.onerror=null; this.src='{% static 'images/default.jpg' %}';"
            />
            {% endif %}
          {% else %}
          <img
            src="{% static 'images/default.jpg' %}"
            alt="{{ ad.title }}"
            class="img-fluid ad-detail-image"
          />
          {% endif %}
          
          {% if ad.target_url and ad.url_approved %}
          <div class="mt-4">
            <a
              href="{{ ad.target_url }}"
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-primary btn-lg ad-visit-btn"
            >
              <i class="fas fa-external-link-alt ms-2"></i>برای بازدید اینجا را کلیک کنید
            </a>
            <p class="text-muted small mt-2 mb-0">{{ ad.target_url }}</p>
          </div>
          {% endif %}
          
          {% if ad.city %}
          <div class="mt-3">
            <p class="mb-0">
              <i class="fas fa-map-marker-alt ms-2 text-muted"></i>
              <span class="text-muted">شهر:</span>
              <strong>{{ ad.city }}</strong>
            </p>
          </div>
          {% endif %}
          
          <!-- Favorite Button -->
          <div class="mt-4 d-flex align-items-center justify-content-center gap-3 flex-wrap">
            {% if user.is_authenticated %}
            <form
              action="{% url 'ads:add_ad_to_favorites' ad.id %}"
              method="POST"
              class="d-inline"
            >
              {% csrf_token %}
              {% if not is_favorited %}
              <button type="submit" class="btn btn-success">
                <i class="fas fa-heart ms-1"></i>افزودن به علاقه‌مندی‌ها
              </button>
              {% else %}
              <button type="submit" class="btn btn-secondary">
                <i class="fas fa-heart ms-1"></i>حذف از علاقه‌مندی‌ها
              </button>
              {% endif %}
            </form>
            {% else %}
            <a href="{% url 'account_login' %}" class="btn btn-primary">
              <i class="fas fa-heart ms-1"></i>ورود برای افزودن به علاقه‌مندی‌ها
            </a>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Comment Form Section -->
      <div class="card mb-3 shadow-sm border-0 comment-form-card">
        <div class="card-body">
          {% if user.is_authenticated %}
            {% if user.profile.is_site_verified %}
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="mb-0">ثبت نظر</h5>
                <span class="text-muted small">ارسال به عنوان: {{ user.username }}</span>
              </div>
              <form method="post" action="{% url 'ads:ad_detail' ad.slug %}" class="mt-2">
                {{ comment_form | crispy }}
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="fas fa-paper-plane ms-1"></i>ارسال
                </button>
              </form>
            {% else %}
              <div class="alert alert-warning mb-0" role="alert">
                <i class="fas fa-exclamation-triangle ms-1"></i>
                لطفاً ابتدا تنظیمات حساب کاربری خود را تکمیل کنید.
                <a href="{% url 'complete_setup' %}" class="alert-link">تکمیل تنظیمات</a>
              </div>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">
              <i class="fas fa-info-circle ms-1"></i>
              برای ثبت نظر وارد شوید.
              <a href="{% url 'account_login' %}" class="text-decoration-none">ورود</a>
            </p>
          {% endif %}
        </div>
      </div>

      <!-- Comments List Section -->
      <div class="card mb-4 shadow-sm border-0 comments-card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0">
              <i class="far fa-comments ms-1"></i>نظرات
            </h5>
            <span class="badge bg-secondary">{{ comment_count }}</span>
          </div>
          {% for comment in comments %}
          <div class="comments p-3 rounded mb-3 bg-light border">
            <div class="d-flex align-items-center justify-content-between mb-1">
              <p class="mb-0 fw-semibold">
                <i class="fas fa-user ms-1"></i>{{ comment.author.username }}
              </p>
              <span class="text-muted small">
                <i class="far fa-clock ms-1"></i>{{ comment.created_on }}
              </span>
            </div>
            <div id="comment{{ comment.id }}" class="mb-2">
              {{ comment.body | linebreaks }}
            </div>
            {% if user.is_authenticated and comment.author == user %}
            <div class="d-flex gap-2">
              <form
                method="post"
                action="{% url 'ads:delete_ad_comment' ad.slug comment.id %}"
                class="d-inline"
                onsubmit="return confirm('آیا مطمئن هستید که می‌خواهید این نظر را حذف کنید؟');"
              >
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger">
                  <i class="fas fa-trash ms-1"></i>حذف
                </button>
              </form>
            </div>
            {% endif %}
          </div>
          {% empty %}
          <p class="text-muted text-center py-3">
            <i class="far fa-comment-dots ms-1"></i>
            هنوز نظری ثبت نشده است.
          </p>
          {% endfor %}
        </div>
      </div>

      <div class="mt-4 text-center">
        <a 
          href="{% url 'ads:ads_by_category' ad.category.slug %}"
          class="btn btn-outline-secondary"
        >
          <i class="fas fa-arrow-right ms-2"></i>بازگشت به راهنما {{ ad.category.name }}
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
