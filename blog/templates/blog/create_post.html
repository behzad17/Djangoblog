{% extends 'base.html' %} {% load static %} {% load crispy_forms_tags %} {% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header">
          <h2 class="text-center">ایجاد پست جدید</h2>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" dir="ltr" style="text-align: left;">
            {% csrf_token %}

            <!-- Regular fields -->
            {{ form.title|as_crispy_field }}
            {{ form.category|as_crispy_field }}
            {{ form.excerpt|as_crispy_field }}
            {{ form.featured_image|as_crispy_field }}
            {{ form.content|as_crispy_field }}
            {{ form.external_url|as_crispy_field }}

            <!-- Event date fields (initially hidden) -->
            <div id="event-fields-container" style="display: none">
              {{ form.event_start_date|as_crispy_field }}
              {{ form.event_end_date|as_crispy_field }}
            </div>

            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-plus"></i> ایجاد پست
              </button>
              <a href="{% url 'home' %}" class="btn btn-secondary btn-lg me-2">
                <i class="fas fa-arrow-right"></i> انصراف
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %} {% block extras %}
<style>
  /* Force LTR direction for form fields */
  .card-body form input,
  .card-body form textarea,
  .card-body form select {
    direction: ltr;
    text-align: left;
  }
  
  .card-body form label {
    text-align: left;
  }
  
  /* Ensure form help text is LTR */
  .card-body form .help-block,
  .card-body form .form-text {
    direction: ltr;
    text-align: left;
  }
</style>

<!-- Summernote initialization for rich text editing -->
<script>
  $(document).ready(function () {
    $("#id_content").summernote({
      height: 300,
      toolbar: [
        ["style", ["style"]],
        ["font", ["bold", "italic", "underline", "clear"]],
        ["fontname", ["fontname"]],
        ["color", ["color"]],
        ["para", ["ul", "ol", "paragraph"]],
        ["table", ["table"]],
        ["insert", ["link", "picture", "video"]],
        ["view", ["fullscreen", "codeview", "help"]],
      ],
    });
  });
</script>

<!-- Event date fields toggle (vanilla JavaScript for reliability) -->
<script>
  // Function to show/hide event date fields based on category selection
  function toggleEventFields() {
    const categorySelect = document.getElementById("id_category");
    const eventFieldsContainer = document.getElementById(
      "event-fields-container"
    );
    const startDateField = document.getElementById("id_event_start_date");
    const endDateField = document.getElementById("id_event_end_date");

    if (!categorySelect || !eventFieldsContainer) {
      return;
    }

    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    if (selectedOption && selectedOption.value) {
      const categoryText = selectedOption.text.trim();
      const categoryValue = selectedOption.value;

      // Check if Events category is selected (check both English and Persian names)
      // Also check if the category slug matches 'events-announcements'
      // Get category slug by checking the option's value (category ID) or text
      const isEventsCategory = categoryText === "Events" || 
                               categoryText === "رویدادها" || 
                               categoryText.includes("رویداد") ||
                               categoryText.toLowerCase().includes("event");
      
      if (isEventsCategory) {
        // Show event fields with smooth transition
        eventFieldsContainer.style.display = "block";
        eventFieldsContainer.style.opacity = "0";
        setTimeout(function () {
          eventFieldsContainer.style.transition = "opacity 0.3s ease";
          eventFieldsContainer.style.opacity = "1";
        }, 10);

        if (startDateField) startDateField.setAttribute("required", "required");
        if (endDateField) endDateField.setAttribute("required", "required");
      } else {
        // Hide event fields
        eventFieldsContainer.style.transition = "opacity 0.3s ease";
        eventFieldsContainer.style.opacity = "0";
        setTimeout(function () {
          eventFieldsContainer.style.display = "none";
        }, 300);

        if (startDateField) {
          startDateField.removeAttribute("required");
          startDateField.value = "";
        }
        if (endDateField) {
          endDateField.removeAttribute("required");
          endDateField.value = "";
        }
      }
    } else {
      // No category selected
      eventFieldsContainer.style.display = "none";
      if (startDateField) startDateField.removeAttribute("required");
      if (endDateField) endDateField.removeAttribute("required");
    }
  }

  // Initialize when DOM is ready
  function initEventFields() {
    // Check on page load
    toggleEventFields();

    // Check on category change
    const categorySelect = document.getElementById("id_category");
    if (categorySelect) {
      categorySelect.addEventListener("change", toggleEventFields);
    }
  }

  // Wait for DOM to be fully loaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initEventFields);
  } else {
    // DOM already loaded
    initEventFields();
  }
</script>
{% endblock extras %}
