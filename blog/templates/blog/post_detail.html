{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}
<div class="masthead">
  <div class="container">
    <div class="row g-0">
      <div class="col-md-6 masthead-text">
        <h1 class="post-title">{{ post.title }}</h1>
        <p class="post-subtitle">{{ post.author }} | {{ post.created_on }}</p>
        {% if post.category %}
        <div class="mb-3">
          <a href="{% url 'category_posts' post.category.slug %}" class="category-badge-large">
            <i class="fas fa-tag me-2"></i>{{ post.category.name }}
          </a>
        </div>
        {% endif %}
        {% if user.is_authenticated and user == post.author %}
        <div class="mb-3 d-flex flex-wrap gap-2">
          <a href="{% url 'edit_post' post.slug %}" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-edit me-1"></i> Edit Post
          </a>
          <a href="{% url 'delete_post' post.slug %}" class="btn btn-sm btn-outline-danger">
            <i class="fas fa-trash me-1"></i> Delete Post
          </a>
        </div>
        {% endif %}
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <!-- Favorite Button -->
          {% if user.is_authenticated %}
          <form
            action="{% url 'add_to_favorites' post.id %}"
            method="POST"
            class="d-inline"
          >
            {% csrf_token %} {% if not is_favorited %}
            <button type="submit" class="btn btn-success">
              Add to Favorite
            </button>
            {% else %}
            <button type="button" class="btn btn-secondary" disabled>
              Added to Favorites
            </button>
            {% endif %}
          </form>
          {% else %}
          <a href="{% url 'account_login' %}" class="btn btn-primary"
            >Login to add favorite</a
          >
          {% endif %}
          <span class="ms-2">{{ post.favorite_count }}</span>
          
          <!-- Like Button -->
          <div class="like-section">
            {% if user.is_authenticated %}
            <form
              action="{% url 'like_post' post.id %}"
              method="POST"
              class="d-inline"
            >
              {% csrf_token %}
              <button 
                type="submit" 
                class="btn-like {% if is_liked %}liked{% endif %}"
                title="{% if is_liked %}Unlike{% else %}Like{% endif %} this post"
              >
                <i class="{% if is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                <span class="like-count">{{ post.like_count }}</span>
              </button>
            </form>
            {% else %}
            <a href="{% url 'account_login' %}" class="btn-like" title="Login to like">
              <i class="far fa-heart"></i>
              <span class="like-count">{{ post.like_count }}</span>
            </a>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="d-none d-md-block col-md-6 masthead-image">
        {% if "placeholder" in post.featured_image.url %}
        <img
          src="{% static 'images/default.jpg' %}"
          class="scale"
          alt="placeholder"
        />
        {% else %}
        <img
          src="{{ post.featured_image.url }}"
          class="scale"
          alt="{{ post.title }}"
        />
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mt-4 mb-5">
  <div class="row g-4">
    <div class="col-lg-9 col-md-12">
      <!-- Post Content Card -->
      <div class="card mb-4 shadow-sm border-0 post-detail-card">
      <div class="card-body">
          <div class="d-flex align-items-center gap-3 flex-wrap mb-3">
            <span class="badge bg-light text-dark border">
              <i class="far fa-clock me-1"></i>{{ post.created_on }}
            </span>
            <span class="badge bg-light text-dark border">
              <i class="far fa-comments me-1"></i>{{ comment_count }} Comments
            </span>
          </div>
          
          <!-- Event Dates Display (only for Events category) -->
          {% if post.category.slug == 'events' and post.event_start_date %}
          <div class="event-dates-info mb-4">
            <div class="card bg-primary text-white">
              <div class="card-body">
                <h5 class="card-title mb-2">
                  <i class="fas fa-calendar-alt me-2"></i>Event Dates
                </h5>
                <p class="mb-0">
                  <strong>Start:</strong> {{ post.event_start_date|date:"F d, Y" }}
                  {% if post.event_end_date %}
                  <br>
                  <strong>End:</strong> {{ post.event_end_date|date:"F d, Y" }}
                  {% endif %}
                </p>
              </div>
            </div>
          </div>
          {% endif %}
          
          <div class="card-text post-content-body">
            {{ post.content | safe }}
          </div>
          {% if post.external_url and post.url_approved %}
          <div class="text-center mt-4 mb-3">
            <a href="{{ post.external_url }}" target="_blank" rel="noopener noreferrer" class="external-url-badge-related">
              <i class="fas fa-external-link-alt me-2"></i>Visit Related Link
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Comment Form (now above comments) -->
      <div class="card mb-3 shadow-sm border-0 comment-form-card">
        <div class="card-body">
          {% if user.is_authenticated %}
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 class="mb-0">Leave a comment</h5>
            <span class="text-muted small">Posting as: {{ user.username }}</span>
    </div>
          <form id="commentForm" method="post" action="{% url 'post_detail' post.slug %}" class="mt-2">
            {{ comment_form | crispy }} {% csrf_token %}
            <button id="submitButton" type="submit" class="btn btn-primary btn-sm">
              Submit
            </button>
          </form>
          {% else %}
          <p class="text-muted mb-0">Log in to leave a comment</p>
          {% endif %}
    </div>
  </div>

      <!-- Comments Section -->
      <div class="card mb-4 shadow-sm border-0 comments-card">
      <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0">Comments</h5>
            <span class="badge bg-secondary">{{ comment_count }}</span>
          </div>
        {% for comment in comments %}
          <div class="comments p-3 rounded mb-3 bg-light border">
            <div class="d-flex align-items-center justify-content-between mb-1">
              <p class="mb-0 fw-semibold">{{ comment.author }}</p>
              <span class="text-muted small">{{ comment.created_on }}</span>
            </div>
            <div id="comment{{ comment.id }}" class="mb-2">
            {{ comment.body | linebreaks }}
          </div>
          {% if user.is_authenticated and comment.author == user %}
            <div class="d-flex gap-2">
            <a
              href="{% url 'comment_delete' post.slug comment.id %}"
              class="btn btn-sm btn-outline-danger"
              >Delete</a
            >
            <button
              class="btn btn-sm btn-outline-secondary edit-comment"
              data-comment-id="{{ comment.id }}"
            >
              Edit
            </button>
          </div>
          {% endif %}
        </div>
        {% empty %}
          <p class="text-muted">No comments yet.</p>
        {% endfor %}
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-3 col-md-12 sidebar-wrapper">
      <!-- Ad Above Popular Posts -->
      <div class="ad-placeholder ad-placeholder-top mb-3">
        <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
          <img src="{% static 'images/ad-top.jpg' %}" alt="Advertisement" class="ad-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="ad-content" style="display: none;">
            <i class="fas fa-ad"></i>
            <p class="ad-text">Your Ads Here!</p>
          </div>
        </a>
      </div>

      <div class="popular-posts-sidebar">
        <h4 class="sidebar-title">
          <i class="fas fa-fire me-2"></i>Popular Posts
        </h4>
        {% if popular_posts %}
        <ol class="popular-posts-list">
          {% for p in popular_posts %}
          <li class="popular-post-item">
            <a href="{% url 'post_detail' p.slug %}" class="popular-post-link" title="{{ p.title }}">
              {{ p.title|truncatewords:8 }}
            </a>
            <div class="popular-post-meta">
              <span class="popular-post-favorites">
                <i class="fas fa-heart"></i> {{ p.like_count }}
              </span>
              {% if p.category %}
              <a href="{% url 'category_posts' p.category.slug %}" class="popular-post-category">
                <i class="fas fa-tag"></i>
              </a>
              {% endif %}
            </div>
          </li>
          {% endfor %}
        </ol>
        {% else %}
        <p class="text-muted small">No popular posts yet. Be the first to like a post!</p>
        {% endif %}
      </div>

      <!-- Ads Below Popular Posts -->
      <div class="ads-container-bottom">
        <div class="ad-placeholder ad-placeholder-bottom">
          <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
            <img src="{% static 'images/ad-1.jpg' %}" alt="Advertisement 1" class="ad-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="ad-content" style="display: none;">
              <i class="fas fa-ad"></i>
              <p class="ad-text">Your Ads Here!</p>
            </div>
          </a>
        </div>
        <div class="ad-placeholder ad-placeholder-bottom">
          <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
            <img src="{% static 'images/ad-2.jpg' %}" alt="Advertisement 2" class="ad-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="ad-content" style="display: none;">
              <i class="fas fa-ad"></i>
              <p class="ad-text">Your Ads Here!</p>
            </div>
          </a>
        </div>
        <div class="ad-placeholder ad-placeholder-bottom">
          <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
            <img src="{% static 'images/ad-3.jpg' %}" alt="Advertisement 3" class="ad-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="ad-content" style="display: none;">
              <i class="fas fa-ad"></i>
              <p class="ad-text">Your Ads Here!</p>
            </div>
          </a>
        </div>
        <div class="ad-placeholder ad-placeholder-bottom">
          <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
            <img src="{% static 'images/ad-4.jpg' %}" alt="Advertisement 4" class="ad-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="ad-content" style="display: none;">
              <i class="fas fa-ad"></i>
              <p class="ad-text">Your Ads Here!</p>
            </div>
          </a>
        </div>
        <div class="ad-placeholder ad-placeholder-bottom">
          <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
            <img src="{% static 'images/ad-5.jpg' %}" alt="Advertisement 5" class="ad-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="ad-content" style="display: none;">
              <i class="fas fa-ad"></i>
              <p class="ad-text">Your Ads Here!</p>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="deleteModal"
  tabindex="-1"
  aria-labelledby="deleteModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete comment?</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete your comment? This action cannot be
        undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <a id="deleteConfirm" href="#" class="btn btn-danger">Delete</a>
      </div>
    </div>
  </div>
</div>
{% endblock content %} {% block extras %}
<script src="{% static 'js/comments.js' %}"></script>
{% endblock extras %}
