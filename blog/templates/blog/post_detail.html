{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load security_filters %}
{% block title %}{{ post.title }} | Peyvand{% endblock title %}
{% block meta_description %}{% if post.excerpt %}{{ post.excerpt|truncatewords:25 }}{% else %}{{ post.content|striptags|truncatewords:25 }}{% endif %}{% endblock meta_description %}
{% block canonical_url %}{{ request.build_absolute_uri }}{% endblock canonical_url %}
{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "{{ post.title|escapejs }}",
  "author": {
    "@type": "Person",
    "name": "{{ post.author.get_full_name|default:post.author.username|escapejs }}"
  },
  "datePublished": "{{ post.created_on|date:'c' }}",
  "dateModified": "{{ post.updated_on|date:'c' }}",
  {% if post.featured_image and "placeholder" not in post.featured_image.url|default:"" %}"image": "{{ request.scheme }}://{{ request.get_host }}{{ post.featured_image.url }}",{% endif %}
  "publisher": {
    "@type": "Organization",
    "name": "Peyvand",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ request.scheme }}://{{ request.get_host }}{% static 'images/logo1.png' %}"
    }
  },
  {% if post.category %}"articleSection": "{{ post.category.name|escapejs }}",{% endif %}
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ request.build_absolute_uri }}"
  }
}
</script>
{% endblock structured_data %}
{% block content %}
<div class="masthead">
  <div class="container">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-2">
      <ol class="breadcrumb small text-muted mb-0">
        <li class="breadcrumb-item">
          <a href="{% url 'home' %}" class="text-muted text-decoration-none">خانه</a>
        </li>
        {% if post.category %}
        <li class="breadcrumb-item">
          <a href="{% url 'category_posts' post.category.slug %}" class="text-muted text-decoration-none">{{ post.category.name }}</a>
        </li>
        {% endif %}
        <li class="breadcrumb-item active text-muted" aria-current="page">{{ post.title|truncatewords:5 }}</li>
      </ol>
    </nav>
    <div class="row g-0">
      <div class="col-md-6 masthead-text">
        <h1 class="post-title">{{ post.title }}</h1>
        <p class="post-subtitle">{{ post.author }} | {{ post.created_on }}</p>
        {% if post.category %}
        <div class="mb-3">
          <a
            href="{% url 'category_posts' post.category.slug %}"
            class="category-badge-large"
          >
            <i class="fas fa-tag ms-2"></i>{{ post.category.name }}
          </a>
        </div>
        {% endif %}
        {% if user.is_authenticated and user == post.author %}
        <div class="mb-3 d-flex flex-wrap gap-2">
          <a
            href="{% url 'edit_post' post.slug %}"
            class="btn btn-sm btn-outline-primary"
          >
            <i class="fas fa-edit ms-1"></i> ویرایش پست
          </a>
          <a
            href="{% url 'delete_post' post.slug %}"
            class="btn btn-sm btn-outline-danger"
          >
            <i class="fas fa-trash ms-1"></i> حذف پست
          </a>
        </div>
        {% endif %}
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <!-- Favorite Button -->
          {% if user.is_authenticated %}
          <form
            action="{% url 'add_to_favorites' post.id %}"
            method="POST"
            class="d-inline"
          >
            {% csrf_token %}
            {% if not is_favorited %}
            <button type="submit" class="btn btn-success">
              افزودن به علاقه‌مندی‌ها
            </button>
            {% else %}
            <button type="button" class="btn btn-secondary" disabled>
              افزوده شده به علاقه‌مندی‌ها
            </button>
            {% endif %}
          </form>
          {% else %}
          <a href="{% url 'account_login' %}" class="btn btn-primary"
            >ورود برای افزودن به علاقه‌مندی‌ها</a
          >
          {% endif %}
          <span class="me-2">{{ post.favorite_count }}</span>

          <!-- Like Button -->
          <div class="like-section">
            {% if user.is_authenticated %}
            <form
              action="{% url 'like_post' post.id %}"
              method="POST"
              class="d-inline"
            >
              {% csrf_token %}
              <button
                type="submit"
                class="btn-like {% if is_liked %}liked{% endif %}"
                title="{% if is_liked %}حذف لایک{% else %}لایک{% endif %} این پست"
              >
                <i
                  class="{% if is_liked %}fas{% else %}far{% endif %} fa-heart"
                ></i>
                <span class="like-count">{{ post.like_count }}</span>
              </button>
            </form>
            {% else %}
            <a
              href="{% url 'account_login' %}"
              class="btn-like"
              title="ورود برای لایک"
            >
              <i class="far fa-heart"></i>
              <span class="like-count">{{ post.like_count }}</span>
            </a>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="d-none d-md-block col-md-6 masthead-image">
        {% if post.featured_image %}
          {% if "placeholder" in post.featured_image.url|default:"" %}
          <img
            src="{% static 'images/default.jpg' %}"
            class="scale"
            alt="تصویر پیش‌فرض برای {{ post.title }}"
          />
          {% else %}
          <img
            src="{{ post.featured_image.url }}"
            class="scale"
            alt="{{ post.title }}"
            onerror="this.onerror=null; this.src='{% static 'images/default.jpg' %}';"
          />
          {% endif %}
        {% else %}
        <img
          src="{% static 'images/default.jpg' %}"
          class="scale"
          alt="تصویر پیش‌فرض برای {{ post.title }}"
        />
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mt-4 mb-5">
  <div class="row g-4">
    <div class="col-lg-9 col-md-12">
      <!-- Post Content Card -->
      <div class="card mb-4 shadow-sm border-0 post-detail-card">
        <div class="card-body">
          <div class="d-flex align-items-center gap-3 flex-wrap mb-3">
            <span class="badge bg-light text-dark border">
              <i class="far fa-clock ms-1"></i>{{ post.created_on }}
            </span>
            <span class="badge bg-light text-dark border">
              <i class="far fa-comments ms-1"></i>{{ comment_count }} نظر
            </span>
          </div>

          <!-- Event Dates Display (only for Events category) -->
          {% if post.category.slug == 'events-announcements' and post.event_start_date %}
          <div class="event-dates-info mb-4">
            <div class="card bg-primary text-white">
              <div class="card-body">
                <h5 class="card-title mb-2">
                  <i class="fas fa-calendar-alt ms-2"></i>تاریخ رویداد
                </h5>
                <p class="mb-0">
                  <strong>شروع:</strong> {{ post.event_start_date|date:"F d, Y" }}
                  {% if post.event_end_date %}
                  <br />
                  <strong>پایان:</strong> {{ post.event_end_date|date:"F d, Y" }}
                  {% endif %}
                </p>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="card-text post-content-body">
            {{ post.content | sanitize }}
          </div>
          {% if post.external_url and post.url_approved %}
          <div class="text-center mt-4 mb-3">
            <a
              href="{{ post.external_url }}"
              target="_blank"
              rel="noopener noreferrer"
              class="external-url-badge-related"
            >
              <i class="fas fa-external-link-alt ms-2"></i>مشاهده لینک مرتبط
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Comment Form (now above comments) -->
      <div class="card mb-3 shadow-sm border-0 comment-form-card">
        <div class="card-body">
          {% if user.is_authenticated %}
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 class="mb-0">ثبت نظر</h5>
            <span class="text-muted small"
              >ارسال به عنوان: {{ user.username }}</span
            >
          </div>
          <form
            id="commentForm"
            method="post"
            action="{% url 'post_detail' post.slug %}"
            class="mt-2"
          >
            {{ comment_form | crispy }}
            {% csrf_token %}
            <button
              id="submitButton"
              type="submit"
              class="btn btn-primary btn-sm"
            >
              ارسال
            </button>
          </form>
          {% else %}
          <p class="text-muted mb-0">برای ثبت نظر وارد شوید</p>
          {% endif %}
        </div>
      </div>

      <!-- Comments Section -->
      <div class="card mb-4 shadow-sm border-0 comments-card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0">نظرات</h5>
            <span class="badge bg-secondary">{{ comment_count }}</span>
          </div>
          {% for comment in comments %}
          <div class="comments p-3 rounded mb-3 bg-light border">
            <div class="d-flex align-items-center justify-content-between mb-1">
              <p class="mb-0 fw-semibold">{{ comment.author }}</p>
              <span class="text-muted small">{{ comment.created_on }}</span>
            </div>
            <div id="comment{{ comment.id }}" class="mb-2">
              {{ comment.body | linebreaks }}
            </div>
            {% if user.is_authenticated and comment.author == user %}
            <div class="d-flex gap-2">
              <a
                href="{% url 'comment_delete' post.slug comment.id %}"
                class="btn btn-sm btn-outline-danger"
                >حذف</a
              >
              <button
                class="btn btn-sm btn-outline-secondary edit-comment"
                data-comment-id="{{ comment.id }}"
              >
                ویرایش
              </button>
            </div>
            {% endif %}
          </div>
          {% empty %}
          <p class="text-muted">هنوز نظری ثبت نشده است.</p>
          {% endfor %}
        </div>
      </div>

      <!-- Related Posts Section -->
      {% if related_posts %}
      <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="fas fa-th-list ms-2"></i>پست‌های مرتبط
          </h5>
          <div class="row g-3">
            {% for related_post in related_posts %}
            <div class="col-md-4 col-sm-6">
              <div class="card post-card h-100">
                <div class="card-body">
                  <div class="image-container">
                    {% if related_post.featured_image %}
                      {% if "placeholder" in related_post.featured_image.url|default:"" %}
                      <img
                        class="card-img-top"
                        src="{% static 'images/default.jpg' %}"
                        alt="تصویر پیش‌فرض برای {{ related_post.title }}"
                        loading="lazy"
                      />
                      {% else %}
                      <img
                        class="card-img-top"
                        src="{{ related_post.featured_image.url }}"
                        alt="{{ related_post.title }}"
                        loading="lazy"
                        data-fallback="{% static 'images/default.jpg' %}"
                        onerror="this.onerror=null; this.src=this.dataset.fallback;"
                      />
                      {% endif %}
                    {% else %}
                    <img
                      class="card-img-top"
                      src="{% static 'images/default.jpg' %}"
                      alt="تصویر پیش‌فرض برای {{ related_post.title }}"
                      loading="lazy"
                    />
                    {% endif %}
                  </div>
                  <a href="{% url 'post_detail' related_post.slug %}" class="post-link">
                    <h6 class="card-title">{{ related_post.title|truncatewords:8 }}</h6>
                  </a>
                  {% if related_post.category %}
                  <div class="mb-2">
                    <a
                      href="{% url 'category_posts' related_post.category.slug %}"
                      class="category-badge"
                    >
                      <i class="fas fa-tag ms-1"></i>{{ related_post.category.name }}
                    </a>
                  </div>
                  {% endif %}
                  <p class="post-author-inline small">نویسنده: {{ related_post.author }}</p>
                  <hr class="my-2" />
                  <p class="card-text text-muted small mb-0">
                    {{ related_post.created_on|date:"M d, Y" }} | <i class="far fa-comments"></i> {{ related_post.comment_count|default:0 }}
                  </p>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-3 col-md-12 sidebar-wrapper">
      <!-- Ad Above Popular Posts -->
      <div class="ad-placeholder ad-placeholder-top mb-3">
        <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
          <img
            src="{% static 'images/ad-top.jpg' %}"
            alt="تبلیغات"
            class="ad-image"
            loading="lazy"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <div class="ad-content" style="display: none">
            <i class="fas fa-ad"></i>
            <p class="ad-text">Your Ads Here!</p>
          </div>
        </a>
      </div>

      <div class="popular-posts-sidebar">
        <h4 class="sidebar-title">
          <i class="fas fa-star ms-2"></i>مطالب تخصصی
        </h4>
        {% if popular_posts %}
        <ol class="popular-posts-list">
          {% for p in popular_posts %}
          <li class="popular-post-item">
            <div class="popular-post-content">
              <a
                href="{% url 'post_detail' p.slug %}"
                class="popular-post-thumbnail"
                title="{{ p.title }}"
              >
                {% if p.featured_image %}
                  {% if "placeholder" in p.featured_image.url|default:"" %}
                  <img
                    src="{% static 'images/default.jpg' %}"
                    alt="{{ p.title }}"
                    class="popular-post-image"
                    loading="lazy"
                  />
                  {% else %}
                  <img
                    src="{{ p.featured_image.url }}"
                    alt="{{ p.title }}"
                    class="popular-post-image"
                    loading="lazy"
                    onerror="this.onerror=null; this.src='{% static 'images/default.jpg' %}';"
                  />
                  {% endif %}
                {% else %}
                <img
                  src="{% static 'images/default.jpg' %}"
                  alt="{{ p.title }}"
                  class="popular-post-image"
                  loading="lazy"
                />
                {% endif %}
              </a>
              <div class="popular-post-text">
                <a
                  href="{% url 'post_detail' p.slug %}"
                  class="popular-post-link"
                  title="{{ p.title }}"
                >
                  {{ p.title|truncatewords:8 }}
                </a>
                <div class="popular-post-author">
                  <i class="fas fa-user ms-1"></i>{{ p.author.username }}
                </div>
              </div>
            </div>
          </li>
          {% endfor %}
        </ol>
        {% else %}
        <p class="text-muted small">هنوز مطالب تخصصی در دسترس نیست.</p>
        {% endif %}
      </div>

      <!-- Ads Below Popular Posts -->
      <div class="ads-container-bottom">
        <div class="ad-placeholder ad-placeholder-bottom">
          <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
            <img
              src="{% static 'images/ad-1.jpg' %}"
              alt="تبلیغات"
              class="ad-image"
              loading="lazy"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <div class="ad-content" style="display: none">
              <i class="fas fa-ad"></i>
              <p class="ad-text">Your Ads Here!</p>
            </div>
          </a>
        </div>
        <div class="ad-placeholder ad-placeholder-bottom">
          <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
            <img
              src="{% static 'images/ad-2.jpg' %}"
              alt="تبلیغات"
              class="ad-image"
              loading="lazy"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <div class="ad-content" style="display: none">
              <i class="fas fa-ad"></i>
              <p class="ad-text">Your Ads Here!</p>
            </div>
          </a>
        </div>
        <div class="ad-placeholder ad-placeholder-bottom">
          <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
            <img
              src="{% static 'images/ad-3.jpg' %}"
              alt="تبلیغات"
              class="ad-image"
              loading="lazy"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <div class="ad-content" style="display: none">
              <i class="fas fa-ad"></i>
              <p class="ad-text">Your Ads Here!</p>
            </div>
          </a>
        </div>
        <div class="ad-placeholder ad-placeholder-bottom">
          <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
            <img
              src="{% static 'images/ad-4.jpg' %}"
              alt="تبلیغات"
              class="ad-image"
              loading="lazy"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <div class="ad-content" style="display: none">
              <i class="fas fa-ad"></i>
              <p class="ad-text">Your Ads Here!</p>
            </div>
          </a>
        </div>
        <div class="ad-placeholder ad-placeholder-bottom">
          <a href="#" target="_blank" rel="noopener noreferrer" class="ad-link">
            <img
              src="{% static 'images/ad-5.jpg' %}"
              alt="تبلیغات"
              class="ad-image"
              loading="lazy"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <div class="ad-content" style="display: none">
              <i class="fas fa-ad"></i>
              <p class="ad-text">Your Ads Here!</p>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="deleteModal"
  tabindex="-1"
  aria-labelledby="deleteModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">حذف نظر؟</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="بستن"
        ></button>
      </div>
      <div class="modal-body">
        آیا مطمئن هستید که می‌خواهید نظر خود را حذف کنید؟ این عمل قابل بازگشت
        نیست.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          بستن
        </button>
        <a id="deleteConfirm" href="#" class="btn btn-danger">حذف</a>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extras %}
<script src="{% static 'js/comments.js' %}" defer></script>
{% endblock extras %}
